<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Meet</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%2360a5fa'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' fill='white' font-family='Arial,Helvetica,sans-serif'%3EG%3C/text%3E%3C/svg%3E"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: dark }
    .tile { aspect-ratio: 16 / 9 }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">
  <header class="flex items-center justify-between gap-3 px-4 h-14 border-b border-slate-800 bg-slate-950/80">
    <div class="flex items-center gap-2">
      <span class="text-xs px-2 py-1 rounded-md border border-slate-700 bg-slate-900">Global Room</span>
      <code id="roomCode" class="text-xs px-2 py-1 rounded-md border border-slate-700 bg-slate-900">global</code>
      <button id="copyLink" class="text-xs px-2 py-1 rounded-md border border-blue-700 bg-blue-600 hover:bg-blue-500">Copy link</button>
    </div>
    <div class="text-sm text-slate-400" id="status">initializing…</div>
  </header>

  <main class="flex-1 min-h-0 flex flex-col">
    <section id="grid" class="grid gap-2 p-2" style="grid-template-columns: repeat(1,minmax(0,1fr))">
      <!-- tiles injected here -->
    </section>

    <div class="flex items-center justify-center py-4 border-t border-slate-800 bg-slate-950/80">
      <div class="flex items-center gap-3 px-3 py-2 rounded-full border border-slate-700 bg-slate-900/90 shadow-lg">
        <button id="micBtn" class="w-12 h-12 rounded-full grid place-items-center bg-slate-800 hover:bg-slate-700" title="Toggle microphone" aria-pressed="false">
          <svg id="micOn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2zM7 22h10v-2H7z"/></svg>
          <svg id="micOff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden"><path d="M19 11a7 7 0 0 1-7 7v3h-2v-3a7 7 0 0 1-6-7h2a5 5 0 0 0 10 0h2zM12 3a3 3 0 0 1 3 3v5a3 3 0 0 1-5.12 2.1L15 7.98V6a3 3 0 0 0-3-3z"/></svg>
        </button>
        <button id="deafenBtn" class="w-12 h-12 rounded-full grid place-items-center bg-slate-800 hover:bg-slate-700" title="Deafen (mute incoming)" aria-pressed="false">
          <svg id="deafenOn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3a4.5 4.5 0 0 0-4.5-4.5v-2A6.5 6.5 0 0 1 18.5 12h-2zM17 12a3 3 0 0 0-3-3v2a1 1 0 0 1 1 1h2z"/></svg>
          <svg id="deafenOff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden"><path d="M3.27 2 2 3.27 7.73 9H3v6h4l5 5v-6.73l5.73 5.73L20 20.73 3.27 2zM14 3.97v2.02a6.5 6.5 0 0 1 6.5 6.5h-2A4.5 4.5 0 0 0 14 6z"/></svg>
        </button>
        <button id="leaveBtn" class="w-12 h-12 rounded-full grid place-items-center bg-red-800 hover:bg-red-700" title="Leave call">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M5 15c3.866-3.866 10.134-3.866 14 0l3-3C16.5 6.5 7.5 6.5 2 12l3 3z"/></svg>
        </button>
      </div>
    </div>
  </main>

  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-4 px-3 py-2 rounded-md border border-slate-700 bg-slate-900 text-sm hidden"></div>

  <!-- Name join overlay -->
  <div id="joinOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm grid place-items-center">
    <div class="w-full max-w-md mx-auto p-6 rounded-2xl border border-slate-700 bg-slate-900 shadow-xl">
      <h2 class="text-lg font-semibold mb-2">Join Global Room</h2>
      <p class="text-sm text-slate-400 mb-4">Choose a display name and click Join.</p>
      <div class="flex items-center gap-2">
        <input id="nameInput" class="flex-1 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="Your name" />
        <button id="joinBtn" class="px-4 py-2 rounded-lg border border-blue-700 bg-blue-600 hover:bg-blue-500">Join</button>
      </div>
    </div>
  </div>

  <!-- Client-side signaling libs (public hubs) -->
  <script src="https://unpkg.com/signalhub@5.5.1/signalhub.min.js"></script>
  <script src="https://unpkg.com/webrtc-swarm@3.35.0/index.js"></script>
  <script>
  (async function(){
    const statusEl = document.getElementById('status');
    const grid = document.getElementById('grid');
    const toast = document.getElementById('toast');
    const copyLinkBtn = document.getElementById('copyLink');
    const micBtn = document.getElementById('micBtn');
    const deafenBtn = document.getElementById('deafenBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const micOn = document.getElementById('micOn');
    const micOff = document.getElementById('micOff');
    const deafenOn = document.getElementById('deafenOn');
    const deafenOff = document.getElementById('deafenOff');

    // Global room (single room for everyone)
    const APP = 'global-meet';
    const HUBS = [
      'https://signalhub-jccqtwhdwc.now.sh',
      'https://signalhub.p2p.party'
    ];

    const ICE = [{ urls: 'stun:stun.l.google.com:19302' }];

    function updateLayout(){
      const n = document.querySelectorAll('#grid .tile').length;
      let cols = 1;
      if (n === 1) cols = 1;
      else if (n === 2) cols = 2;
      else if (n <= 4) cols = 2;
      else if (n <= 6) cols = 3;
      else if (n <= 9) cols = 3;
      else cols = 4;
      document.getElementById('grid').style.gridTemplateColumns = repeat(${cols}, minmax(0, 1fr));
    }

    function show(t){ toast.textContent=t; toast.classList.remove('hidden'); clearTimeout(show._t); show._t = setTimeout(()=>toast.classList.add('hidden'), 1200); }
    async function copyLink(){ try{ await navigator.clipboard.writeText(location.href); show('Link copied'); } catch { show('Copy failed'); } }
    copyLinkBtn.onclick = copyLink;

    // Name selection overlay and join flow
    const joinOverlay = document.getElementById('joinOverlay');
    const nameInput = document.getElementById('nameInput');
    const joinBtn = document.getElementById('joinBtn');
    nameInput.value = localStorage.getItem('displayName') || '';
    let displayName = '';

    // Media
    let localStream = null;
    async function getMedia(){
      statusEl.textContent = 'Requesting microphone…';
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
        statusEl.textContent = 'Ready • waiting for peers';
      } catch (e) {
        statusEl.textContent = 'No microphone available';
        show('Microphone permission blocked');
        return false;
      }
      return true;
    }

    function addSelfTile(){
      const you = document.createElement('div'); you.className = 'tile relative rounded-xl overflow-hidden bg-gradient-to-br from-amber-900 to-amber-800';
      you.innerHTML = '\
        <div class="absolute inset-0 grid place-items-center pointer-events-none">\
          <div class="w-16 h-16 rounded-full bg-orange-500/90 ring-2 ring-white/40 text-white grid place-items-center text-2xl font-semibold">'+escapeHtml(displayName.charAt(0).toUpperCase())+'</div>\
        </div>\
        <div class="absolute left-2 bottom-2 text-xs px-2 py-1 rounded-md bg-black/60">'+escapeHtml(displayName)+' (you)</div>';
      grid.prepend(you);
      updateLayout();
    }

    async function beginJoin(){
      displayName = (nameInput.value || '').trim() || 'Guest';
      localStorage.setItem('displayName', displayName);
      joinOverlay.classList.add('hidden');
      if (!(await getMedia())) return;
      addSelfTile();
      await connectNetwork();
    }
    joinBtn.onclick = beginJoin;

    let swarm = null;
    const peers = new Map(); // unified peers
    let deafened = false;

    async function connectNetwork(){
      statusEl.textContent = 'Connecting to network…';
      try {
        if (!window.signalhub) throw new Error('signalhub not loaded');
        const hub = signalhub(APP, HUBS);
        const SwarmCtor = window.Swarm || window.WebRTCSwarm || window.default;
        if (!SwarmCtor) throw new Error('webrtc-swarm not loaded');
        swarm = SwarmCtor(hub, { stream: localStream, config: { iceServers: ICE } });
        statusEl.textContent = 'Ready • waiting for peers';
        wireSwarm();
      } catch (e) {
        console.warn('Signaling libraries unavailable:', e);
        statusEl.textContent = 'Local test mode • open a second tab';
        wireLocalBroadcast();
      }
      setTimeout(() => refreshStatus(), 1500);
      setInterval(() => refreshStatus(), 5000);
    }

    // const peers declared above (unified for swarm/local)

    function refreshStatus(){ statusEl.textContent = Online • ${peers.size} peer${peers.size===1?'':'s'}; }

    swarm && swarm.on('peer', (peer, id) => {
      peers.set(id, peer);
      refreshStatus();
      peer.on('stream', (stream) => addRemoteTile(id, stream));
      peer.on('connect', () => { try { peer.send(JSON.stringify({ type:'meta', name: displayName })); } catch {} });
      peer.on('data', (buf) => {
        try {
          const msg = JSON.parse(String(buf));
          if (msg && msg.type === 'meta' && msg.name) labelPeer(id, msg.name);
        } catch {}
      });
      peer.on('close', () => { removeRemote(id); refreshStatus(); });
      peer.on('error', () => { removeRemote(id); refreshStatus(); });
    });
    // Best-effort hub error notice (optional)
    // Note: if offline (no swarm), you can still use mic locally

    // Local tab-to-tab fallback signaling using BroadcastChannel
    function wireLocalBroadcast(){
      const channel = new BroadcastChannel('global-meet-local');
      const myId = Math.random().toString(36).slice(2,10);
      const conns = new Map();

      function createPC(id){
        const pc = new RTCPeerConnection({ iceServers: ICE });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = (e)=>{ const [s] = e.streams; addRemoteTile(id, s); };
        pc.onicecandidate = (e)=>{ if (e.candidate) channel.postMessage({ t:'ice', to:id, from:myId, c:e.candidate }); };
        pc.onconnectionstatechange = ()=>{ if (pc.connectionState==='disconnected' || pc.connectionState==='failed') { removeRemote(id); } };
        conns.set(id, pc); peers.set(id, pc); refreshStatus();
        return pc;
      }

      channel.onmessage = async (ev)=>{
        const m = ev.data || {}; if (m.from === myId) return;
        if (m.t === 'hello'){
          if (myId > m.from){ const pc = createPC(m.from); const offer = await pc.createOffer(); await pc.setLocalDescription(offer); channel.postMessage({ t:'offer', to:m.from, from:myId, s:pc.localDescription }); }
        } else if (m.t === 'offer' && m.to === myId){
          const pc = createPC(m.from); await pc.setRemoteDescription(m.s); const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); channel.postMessage({ t:'answer', to:m.from, from:myId, s:pc.localDescription });
        } else if (m.t === 'answer' && m.to === myId){
          const pc = conns.get(m.from); if (pc) await pc.setRemoteDescription(m.s);
        } else if (m.t === 'ice' && m.to === myId){
          const pc = conns.get(m.from); if (pc && m.c) try{ await pc.addIceCandidate(m.c); } catch{}
        } else if (m.t === 'bye'){
          const pc = conns.get(m.from); if (pc) pc.close(); conns.delete(m.from); removeRemote(m.from); peers.delete(m.from); refreshStatus();
        } else if (m.t === 'meta'){
          labelPeer(m.from, m.name);
        }
      };

      channel.postMessage({ t:'hello', from:myId });
      channel.postMessage({ t:'meta', from:myId, name: localStorage.getItem('displayName') || 'Guest' });
      window.addEventListener('beforeunload',()=>{ channel.postMessage({ t:'bye', from:myId }); conns.forEach(pc=>pc.close()); });
    }

    // UI actions
    micBtn.onclick = () => {
      const track = localStream.getAudioTracks()[0];
      if (!track) return;
      track.enabled = !track.enabled;
      micOn.classList.toggle('hidden', !track.enabled);
      micOff.classList.toggle('hidden', track.enabled);
      micBtn.setAttribute('aria-pressed', String(!track.enabled));
      micBtn.classList.toggle('bg-red-700', !track.enabled);
      micBtn.classList.toggle('hover:bg-red-600', !track.enabled);
      micBtn.classList.toggle('bg-slate-800', track.enabled);
      micBtn.classList.toggle('hover:bg-slate-700', track.enabled);
      show(track.enabled ? 'Unmuted' : 'Muted');
    };
    let deafened = false;
    deafenBtn.onclick = () => {
      deafened = !deafened;
      document.querySelectorAll('[data-peer] audio').forEach(a => a.muted = deafened);
      document.querySelectorAll('[data-peer] audio').forEach(a => { try { a.play(); } catch {} });
      deafenBtn.setAttribute('aria-pressed', String(deafened));
      deafenBtn.classList.toggle('bg-yellow-700', deafened);
      deafenBtn.classList.toggle('hover:bg-yellow-600', deafened);
      deafenBtn.classList.toggle('bg-slate-800', !deafened);
      deafenBtn.classList.toggle('hover:bg-slate-700', !deafened);
      document.getElementById('deafenOn').classList.toggle('hidden', deafened);
      document.getElementById('deafenOff').classList.toggle('hidden', !deafened);
      show(deafened ? 'Deafened' : 'Undeafened');
    };
    leaveBtn.onclick = () => { cleanup(); location.reload(); };
    // (Camera and screen share removed by request)

    function addRemoteTile(id, stream){
      let el = document.querySelector('[data-peer="'+id+'"]');
      if (!el){
        el = document.createElement('div');
        el.className = 'tile relative rounded-xl overflow-hidden bg-gradient-to-br from-amber-900 to-amber-800';
        el.dataset.peer = id;
        el.innerHTML = '\
          <audio autoplay class="hidden"></audio>\
          <div class="absolute inset-0 grid place-items-center pointer-events-none">\
            <div class="w-16 h-16 rounded-full bg-orange-500/90 ring-2 ring-white/40 text-white grid place-items-center text-2xl font-semibold" data-initial>?</div>\
          </div>\
          <div class="absolute left-2 bottom-2 text-xs px-2 py-1 rounded-md bg-black/60" data-label>'+id.slice(0,6)+'</div>';
        grid.append(el);
      }
      const audio = el.querySelector('audio');
      if (audio) { audio.srcObject = stream; audio.muted = document.getElementById('deafenBtn')?.getAttribute('aria-pressed') === 'true'; try { audio.play(); } catch {} }
      updateLayout();
      // Always show initial badge (name only UI)
    }
    function labelPeer(id, name){ const el = document.querySelector('[data-peer="'+id+'"] [data-label]'); if (el) el.textContent = name; const badge = document.querySelector('[data-peer="'+id+'"] [data-initial]'); if (badge) badge.textContent = (name||'?').trim().charAt(0).toUpperCase(); }
    function removeRemote(id){ const el = document.querySelector('[data-peer="'+id+'"]'); if (el) el.remove(); peers.delete(id); updateLayout(); }
    function cleanup(){ try { swarm.close(); } catch {} peers.forEach(p=>{ try{p.destroy()}catch{} }); if (localStream) localStream.getTracks().forEach(t=>t.stop()); }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
    window.addEventListener('beforeunload', cleanup);
  })();
  </script>
</body>
</html>