<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="color-scheme" content="dark"/>
<title>Global Meet â€” Single File Static</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%2360a5fa'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' fill='white'%3EG%3C/text%3E%3C/svg%3E">
<!-- Tailwind via CDN (safe for static) -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { color-scheme: dark }
  .tile { aspect-ratio:16/9; position:relative }
  .avatar-wrap{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none}
  .avatar{width:4.2rem;height:4.2rem;border-radius:9999px;background:linear-gradient(135deg,#60a5fa,#4f46e5);color:#fff;
          display:grid;place-items:center;font-weight:700;font-size:1.7rem;box-shadow:0 0 0 2px rgba(255,255,255,.25)}
  .viz{position:absolute; width:11rem; height:11rem; pointer-events:none; filter:drop-shadow(0 10px 22px rgba(59,130,246,.28))}
  .msg-enter{opacity:0; transform:translateY(6px)} .msg-enter.go{opacity:1; transform:none; transition:opacity .16s ease, transform .16s ease}
  .kbd{border:1px solid #334;padding:.05rem .35rem;border-radius:.375rem;background:#0b1220;font-size:.8em}
</style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">

<header class="flex flex-wrap items-center gap-3 px-4 py-2 border-b border-slate-800 bg-slate-950/80">
  <div class="flex items-center gap-2 min-w-[14rem]">
    <span class="text-xs px-2 py-1 rounded-md border border-slate-700 bg-slate-900">Global Room</span>
    <code class="text-xs px-2 py-1 rounded-md border border-slate-700 bg-slate-900">static / no build</code>
  </div>
  <div class="flex items-center gap-2">
    <label class="text-xs text-slate-400">Mic</label>
    <select id="micSelect" class="text-xs px-2 py-1 rounded border border-slate-700 bg-slate-800 min-w-[12rem]"></select>
    <button id="micRetest" class="text-xs px-2 py-1 rounded border border-slate-700 bg-slate-800 hover:bg-slate-700">Retest</button>
  </div>
  <div class="flex items-center gap-2">
    <label class="text-xs text-slate-400">Speaker</label>
    <select id="spkSelect" class="text-xs px-2 py-1 rounded border border-slate-700 bg-slate-800 min-w-[12rem]"></select>
  </div>
  <div class="ml-auto flex items-center gap-2">
    <button id="chatToggle" class="relative text-xs px-3 py-2 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700">
      Chat <span id="chatBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 rounded-full text-[10px] grid place-items-center bg-blue-600">0</span>
    </button>
    <div id="status" class="text-sm text-slate-400">initializingâ€¦</div>
  </div>
</header>

<main class="flex-1 min-h-0 flex">
  <section id="grid" class="flex-1 grid gap-2 p-2" style="grid-template-columns:repeat(1,minmax(0,1fr))"></section>

  <aside id="chatPanel" class="w-[22rem] max-w-[90vw] border-l border-slate-800 bg-slate-950/60 backdrop-blur-md hidden md:flex md:flex-col">
    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-800">
      <div class="text-sm text-slate-300">Room chat</div>
      <button id="chatClose" class="text-xs px-2 py-1 rounded border border-slate-700 bg-slate-800 hover:bg-slate-700">Close</button>
    </div>
    <div id="chatList" class="flex-1 px-3 py-2 overflow-auto space-y-2"></div>
    <div class="p-3 border-t border-slate-800">
      <div class="flex gap-2">
        <input id="chatInput" class="flex-1 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="Message"/>
        <button id="chatSend" class="px-3 py-2 rounded-lg border border-blue-700 bg-blue-600 hover:bg-blue-500 text-xs">Send</button>
      </div>
    </div>
  </aside>
</main>

<div class="flex items-center justify-center py-4 border-t border-slate-800 bg-slate-950/80">
  <div class="flex items-center gap-3 px-3 py-2 rounded-full border border-slate-700 bg-slate-900/90 shadow-lg">
    <button id="micBtn" class="w-12 h-12 rounded-full grid place-items-center bg-slate-800 hover:bg-slate-700" title="Toggle microphone" aria-pressed="false"><span id="micIcon" class="text-lg">ðŸŽ¤</span></button>
    <button id="deafenBtn" class="w-12 h-12 rounded-full grid place-items-center bg-slate-800 hover:bg-slate-700" title="Mute speakers" aria-pressed="false"><span id="deafenIcon" class="text-lg">ðŸ”Š</span></button>
    <button id="monitorBtn" class="px-3 py-2 rounded-lg border border-slate-700 bg-blue-700 hover:bg-blue-600 text-xs" aria-pressed="true" title="Hear your own mic">Monitor: On</button>
    <input id="monitorGain" type="range" min="0" max="100" value="40" class="w-28" title="Monitor volume">
    <button id="presentBtn" class="px-3 py-2 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700 text-xs" aria-pressed="false" title="Share your screen">Present</button>
    <button id="speakerTest" class="text-xs px-2 py-2 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700">Speaker test</button>
    <button id="leaveBtn" class="w-12 h-12 rounded-full grid place-items-center bg-red-800 hover:bg-red-700" title="Leave"><span class="text-lg">ðŸšª</span></button>
  </div>
</div>

<details class="px-4 pb-3 text-xs text-slate-400"><summary>Diagnostics</summary><div id="diag" class="mt-2 whitespace-pre-wrap font-mono"></div></details>

<!-- Join -->
<div id="joinOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm grid place-items-center">
  <div class="w-full max-w-md mx-auto p-6 rounded-2xl border border-slate-700 bg-slate-900 shadow-xl">
    <h2 class="text-lg font-semibold mb-2">Join Global Room</h2>
    <p class="text-sm text-slate-400 mb-4">Choose a display name and click Join.</p>
    <div class="flex items-center gap-2">
      <input id="nameInput" class="flex-1 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="Your name"/>
      <button id="joinBtn" class="px-4 py-2 rounded-lg border border-blue-700 bg-blue-600 hover:bg-blue-500">Join</button>
    </div>
    <p class="mt-2 text-xs text-slate-500">HTTPS is required for mic. If no prompt: allow Microphone in the lock icon â†’ press <span class="kbd">Retest</span>.</p>
  </div>
</div>

<div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-4 px-3 py-2 rounded-md border border-slate-700 bg-slate-900 text-sm hidden"></div>

<script>
(function(){
  // ===== DOM
  const grid = document.getElementById('grid'), statusEl = document.getElementById('status'), toast = document.getElementById('toast');
  const micBtn = document.getElementById('micBtn'), micIcon = document.getElementById('micIcon');
  const deafenBtn = document.getElementById('deafenBtn'), deafenIcon = document.getElementById('deafenIcon');
  const monitorBtn = document.getElementById('monitorBtn'), monitorGain = document.getElementById('monitorGain');
  const presentBtn = document.getElementById('presentBtn'), speakerTestBtn = document.getElementById('speakerTest'), leaveBtn = document.getElementById('leaveBtn');
  const micSelect = document.getElementById('micSelect'), spkSelect = document.getElementById('spkSelect'), micRetest = document.getElementById('micRetest');
  const chatPanel = document.getElementById('chatPanel'), chatToggle = document.getElementById('chatToggle'), chatClose = document.getElementById('chatClose');
  const chatList = document.getElementById('chatList'), chatInput = document.getElementById('chatInput'), chatSend = document.getElementById('chatSend'), chatBadge = document.getElementById('chatBadge');
  const joinOverlay = document.getElementById('joinOverlay'), nameInput = document.getElementById('nameInput'), joinBtn = document.getElementById('joinBtn');
  const diag = document.getElementById('diag');

  // ===== utils
  const SAME_URL_KEY = location.origin + location.pathname;
  function show(t){ toast.textContent=t; toast.classList.remove('hidden'); clearTimeout(show._t); show._t=setTimeout(()=>toast.classList.add('hidden'),1400); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function updateLayout(){ const n=document.querySelectorAll('#grid .tile').length; let cols=1; if(n===1)cols=1; else if(n===2)cols=2; else if(n<=4)cols=2; else if(n<=6)cols=3; else if(n<=9)cols=3; else cols=4; grid.style.gridTemplateColumns=`repeat(${cols},minmax(0,1fr))`; }
  function refreshStatus(){ statusEl.textContent = `Online â€¢ ${peers.size} peer${peers.size===1?'':'s'}`; }
  function log(note, extra){ const ts=new Date().toISOString().slice(11,19); diag.textContent += `[${ts}] ${note}${extra?': '+extra:''}\n`; }

  // ===== state
  nameInput.value = localStorage.getItem('displayName') || '';
  let displayName = '';
  let localStream = null, sendStream = null, sendCtx = null, sendGainNode = null;
  let monitorCtx = null, monitorGainNode = null, monitorSource = null;
  let screenStream = null; const screenSenders = new Map();
  const peerNames = new Map();

  const bc = new BroadcastChannel('global-meet-local');
  const LS_KEY = 'gmeet-signal';
  const myId = (crypto && crypto.randomUUID) ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10);
  const peers = new Map();
  const iceConfig = { iceServers:[{urls:'stun:stun.l.google.com:19302'}] };

  const seen = new Set(); const makeId=()=>`${myId}:${Date.now().toString(36)}:${Math.random().toString(36).slice(2,7)}`;
  function mark(id){ seen.add(id); setTimeout(()=>seen.delete(id), 60000); }
  function accept(m){ if(!m||!m.id) return true; if(seen.has(m.id)) return false; mark(m.id); return true; }

  function send(msg){ msg.url=SAME_URL_KEY; msg.from=myId; msg.id=msg.id||makeId(); mark(msg.id); try{ bc.postMessage(msg);}catch{} try{ localStorage.setItem(LS_KEY, JSON.stringify(msg)+'::'+Math.random()); }catch{} }
  bc.onmessage = e => onSignal(e.data);
  window.addEventListener('storage', e=>{ if(e.key!==LS_KEY||!e.newValue) return; try{ onSignal(JSON.parse(e.newValue.split('::')[0])); }catch{} });
  function onSignal(m){ if(!m||m.url!==SAME_URL_KEY||m.from===myId||!accept(m)) return; handleSignal(m); }

  // ===== viz (radial bars)
  const vis = new Map();
  function mkCanvas(){ const c=document.createElement('canvas'); c.width=240; c.height=240; c.className='viz'; return c; }
  function attachViz(key, stream, mount){
    detachViz(key);
    try{
      const actx = new (window.AudioContext||window.webkitAudioContext)();
      const src = actx.createMediaStreamSource(stream);
      const an = actx.createAnalyser(); an.fftSize=2048; an.smoothingTimeConstant=.76; src.connect(an);
      const data = new Uint8Array(an.frequencyBinCount);
      const cvs = mkCanvas(); mount.appendChild(cvs); const cx=cvs.getContext('2d');
      const N=48, ema=Array(N).fill(0), vel=Array(N).fill(0); const k=.22, d=.18, baseR=62, minH=12, maxH=50; let hue=210;
      const sr = actx.sampleRate||48000, maxf=sr/2, ranges=[]; for(let i=0;i<N;i++){const f1=60*Math.pow(maxf/60,i/N), f2=60*Math.pow(maxf/60,(i+1)/N); const b1=Math.max(1,Math.floor(f1/maxf*data.length)), b2=Math.min(data.length-1,Math.ceil(f2/maxf*data.length)); ranges.push([b1,b2]);}
      function tick(){
        an.getByteFrequencyData(data);
        let energy=0, tgt=new Array(N).fill(0);
        for(let i=0;i<N;i++){ const [b1,b2]=ranges[i]; let s=0,cnt=0; for(let b=b1;b<=b2;b++){ s+=data[b]; cnt++; } const v=cnt?(s/cnt)/255:0; energy+=v; tgt[i]=v;}
        energy=Math.min(1,(energy/N)*1.3); hue=200+energy*45;
        const coupled=tgt.slice(); for(let i=0;i<N;i++){const n1=i>0?tgt[i-1]:tgt[i], n2=i<N-1?tgt[i+1]:tgt[i]; coupled[i]=tgt[i]*.78+(n1+n2)*.11;}
        for(let i=0;i<N;i++){ const a=k*(coupled[i]-ema[i]) - d*vel[i]; vel[i]+=a; ema[i]+=vel[i]; if(ema[i]<0) ema[i]=0; }
        cx.clearRect(0,0,cvs.width,cvs.height); cx.save(); cx.translate(cvs.width/2,cvs.height/2); cx.lineCap='round'; cx.shadowBlur=18; cx.shadowColor=`hsla(${hue},95%,65%,.55)`;
        for(let i=0;i<N;i++){ const ang=i/N*Math.PI*2, val=Math.min(1,ema[i]*1.4), h=minH+(maxH-minH)*val; const x1=Math.cos(ang)*baseR, y1=Math.sin(ang)*baseR, x2=Math.cos(ang)*(baseR+h), y2=Math.sin(ang)*(baseR+h);
          cx.strokeStyle=`hsla(${hue+i*.6},85%,${55+val*25}%,${.55+val*.35})`; cx.lineWidth=3.5+val*2.2; cx.beginPath(); cx.moveTo(x1,y1); cx.lineTo(x2,y2); cx.stroke(); }
        cx.restore(); raf=requestAnimationFrame(tick);
      } let raf=requestAnimationFrame(tick);
      vis.set(key,{ctx:actx,raf,cvs});
    }catch{}
  }
  function detachViz(key){ const v=vis.get(key); if(!v) return; try{ cancelAnimationFrame(v.raf);}catch{} try{ v.ctx.close(); }catch{} try{ v.cvs.remove(); }catch{} vis.delete(key); }

  // ===== tiles
  function ensureTile(id){ let el=document.querySelector(`[data-peer="${id}"]`); if(el) return el;
    el=document.createElement('div'); el.className='tile relative rounded-xl overflow-hidden bg-gradient-to-br from-slate-800 to-slate-700';
    el.dataset.peer=id; el.innerHTML=`<audio autoplay playsinline></audio><div class="avatar-wrap"><div class="avatar" data-initial>?</div></div><div class="absolute left-2 bottom-2 text-xs px-2 py-1 rounded-md bg-black/60" data-label>${id.slice(0,6)}</div>`;
    grid.append(el); updateLayout(); return el; }
  function ensureSelf(){ let el=document.querySelector('[data-self="1"]'); if(el) return el;
    el=document.createElement('div'); el.className='tile relative rounded-xl overflow-hidden bg-gradient-to-br from-slate-800 to-slate-700'; el.setAttribute('data-self','1');
    el.innerHTML=`<div class="avatar-wrap"><div class="avatar" data-initial>?</div></div><div class="absolute left-2 bottom-2 text-xs px-2 py-1 rounded-md bg-black/60" data-label>(you)</div>`;
    grid.prepend(el); updateLayout(); return el; }
  function ensureShare(owner,label){ let el=document.querySelector(`[data-share="${owner}"]`); if(el) return el;
    el=document.createElement('div'); el.className='tile relative rounded-xl overflow-hidden bg-black'; el.dataset.share=owner;
    el.innerHTML=`<video autoplay playsinline muted class="w-full h-full object-contain bg-black"></video><div class="absolute left-2 bottom-2 text-xs px-2 py-1 rounded-md bg-black/60">${escapeHtml(label||'Screen')}</div>`;
    grid.append(el); updateLayout(); return el; }
  function removeShare(owner){ const el=document.querySelector(`[data-share="${owner}"]`); if(el) el.remove(); updateLayout(); }
  function labelPeer(id,name){ const l=document.querySelector(`[data-peer="${id}"] [data-label]`); if(l) l.textContent=name; const b=document.querySelector(`[data-peer="${id}"] [data-initial]`); if(b) b.textContent=(name||'?').trim().charAt(0).toUpperCase(); }
  function labelSelf(name){ const l=document.querySelector('[data-self="1"] [data-label]'); if(l) l.textContent=`${escapeHtml(name)} (you)`; const b=document.querySelector('[data-self="1"] [data-initial]'); if(b) b.textContent=(name||'?').trim().charAt(0).toUpperCase(); }

  // ===== WebRTC
  function createPC(id){
    const pc=new RTCPeerConnection(iceConfig);
    try{ pc.addTransceiver('audio',{direction:'recvonly'});}catch{} try{ pc.addTransceiver('video',{direction:'recvonly'});}catch{}
    if (sendStream) sendStream.getAudioTracks().forEach(t=>pc.addTrack(t, sendStream));
    if (screenStream){ const vTrack=screenStream.getVideoTracks()[0]; if(vTrack){ const sender=pc.addTrack(vTrack, screenStream); screenSenders.set(id, sender); } }
    pc.ontrack=e=>{
      const [stream]=e.streams; const track=e.track;
      if(track.kind==='audio'){ const el=ensureTile(id); const a=el.querySelector('audio'); if(a){ a.srcObject=stream; a.muted=deafenBtn.getAttribute('aria-pressed')==='true'; a.play().catch(()=>{}); const sink=spkSelect.value; if(sink && typeof a.setSinkId==='function') a.setSinkId(sink).catch(()=>{}); }
        const mount=el.querySelector('.avatar-wrap'); attachViz(id, stream, mount); }
      if(track.kind==='video'){ const sEl=ensureShare(id, `${peerNames.get(id)||id.slice(0,6)} â€” Screen`); const v=sEl.querySelector('video'); if(v){ v.srcObject=stream; v.play().catch(()=>{}); } track.onended=()=>removeShare(id); }
    };
    pc.onicecandidate=e=>{ if(e.candidate) send({t:'ice', to:id, c:e.candidate}); };
    pc.onconnectionstatechange=()=>{ const s=pc.connectionState; if(s==='failed'||s==='disconnected'||s==='closed'){ removePeer(id); } };
    peers.set(id,pc); ensureTile(id); refreshStatus(); return pc;
  }
  async function makeOffer(to){ const pc=peers.get(to)||createPC(to); const offer=await pc.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true}); await pc.setLocalDescription(offer); send({t:'offer', to, s:pc.localDescription, id:makeId()}); }
  async function makeAnswer(from,sdp){ const pc=peers.get(from)||createPC(from); await pc.setRemoteDescription(sdp); const ans=await pc.createAnswer(); await pc.setLocalDescription(ans); send({t:'answer', to:from, s:pc.localDescription, id:makeId()}); }
  async function renegotiateAll(){ for(const id of peers.keys()){ try{ await makeOffer(id);}catch{} } }
  function removePeer(id){ detachViz(id); const s=screenSenders.get(id); if(s){ screenSenders.delete(id); } const pc=peers.get(id); if(pc) try{pc.close();}catch{} peers.delete(id); const el=document.querySelector(`[data-peer="${id}"]`); if(el) el.remove(); removeShare(id); refreshStatus(); }

  // ===== Mic chain (boost + compressor)
  async function enumerate(){ try{ const devs=await navigator.mediaDevices.enumerateDevices(); const mics=devs.filter(d=>d.kind==='audioinput'), spks=devs.filter(d=>d.kind==='audiooutput');
    micSelect.innerHTML = mics.length? mics.map(d=>`<option value="${d.deviceId}">${escapeHtml(d.label||'Microphone')}</option>`).join('') : `<option value="">No microphones</option>`;
    spkSelect.innerHTML = `<option value="">Default speaker</option>` + spks.map(d=>`<option value="${d.deviceId}">${escapeHtml(d.label||'Speaker')}</option>`).join(''); }catch(e){ log('enumerateDevices failed', e.name||e.message); } }
  async function getMic(id){ try{ return await navigator.mediaDevices.getUserMedia({audio:{deviceId:id?{exact:id}:undefined,echoCancellation:true,noiseSuppression:true,autoGainControl:true},video:false}); }catch(e){ log('getUserMedia error', e.name||e.message); return null; } }
  async function buildChain(from){ if (sendCtx){ try{ sendCtx.close(); }catch{} } sendCtx=new(window.AudioContext||window.webkitAudioContext)(); const src=sendCtx.createMediaStreamSource(from); const g=sendCtx.createGain(); g.gain.value=1.65; sendGainNode=g; const comp=sendCtx.createDynamicsCompressor(); comp.threshold.value=-24; comp.ratio.value=3.2; comp.attack.value=.003; comp.release.value=.25; const dst=sendCtx.createMediaStreamDestination(); src.connect(g).connect(comp).connect(dst); sendStream=dst.stream; }
  async function attachMic(stream){ if(localStream) localStream.getTracks().forEach(t=>t.stop()); localStream=stream; await buildChain(localStream);
    ensureSelf(); labelSelf(displayName); const mount=document.querySelector('[data-self="1"] .avatar-wrap'); detachViz('self'); attachViz('self', localStream, mount);
    const track=localStream.getAudioTracks()[0]; micIcon.textContent = (track && track.enabled!==false) ? 'ðŸŽ¤' : 'ðŸ”‡';
    peers.forEach(pc=>{ const senders=pc.getSenders().filter(s=>s.track && s.track.kind==='audio'); if(senders.length===0 && sendStream){ sendStream.getTracks().forEach(t=>pc.addTrack(t, sendStream)); } else if (sendStream){ senders.forEach(s=>s.replaceTrack(sendStream.getAudioTracks()[0]||null)); }});
    await renegotiateAll();
  }

  // ===== Monitor
  function monOn(){ return monitorBtn.getAttribute('aria-pressed')==='true'; }
  function stopMon(){ if(!monOn())return; try{ monitorSource?.disconnect(); monitorGainNode?.disconnect(); monitorCtx?.close(); }catch{} monitorCtx=monitorGainNode=monitorSource=null; monitorBtn.setAttribute('aria-pressed','false'); monitorBtn.textContent='Monitor: Off'; monitorBtn.classList.remove('bg-blue-700'); monitorBtn.classList.add('bg-slate-800'); }
  async function startMon(){ if(monOn()||!localStream) return; try{ monitorCtx=new(window.AudioContext||window.webkitAudioContext)(); monitorSource=monitorCtx.createMediaStreamSource(sendStream||localStream); monitorGainNode=monitorCtx.createGain(); monitorGainNode.gain.value=(parseInt(monitorGain.value,10)||40)/100; monitorSource.connect(monitorGainNode).connect(monitorCtx.destination); monitorBtn.setAttribute('aria-pressed','true'); monitorBtn.textContent='Monitor: On'; monitorBtn.classList.add('bg-blue-700'); monitorBtn.classList.remove('bg-slate-800'); }catch(e){ log('monitor failed', e.name||e.message); } }

  // ===== Screen share
  async function startPresent(){ if(screenStream) return; try{ screenStream=await navigator.mediaDevices.getDisplayMedia({video:{frameRate:24},audio:true}); const st=ensureShare('self', `${displayName} â€” Screen`); const v=st.querySelector('video'); if(v){ v.srcObject=screenStream; v.muted=true; v.play().catch(()=>{}); } const vt=screenStream.getVideoTracks()[0]; if(vt){ for(const [pid,pc] of peers.entries()){ const s=pc.addTrack(vt, screenStream); screenSenders.set(pid,s); } vt.onended = stopPresent; } await renegotiateAll(); presentBtn.setAttribute('aria-pressed','true'); presentBtn.textContent='Stop Presenting'; presentBtn.classList.add('bg-blue-700'); presentBtn.classList.remove('bg-slate-800'); show('Presenting'); }catch{ screenStream=null; show('Screen share cancelled'); } }
  async function stopPresent(){ if(!screenStream) return; try{ for(const [pid,pc] of peers.entries()){ const s=screenSenders.get(pid); if(s){ try{ pc.removeTrack(s);}catch{} screenSenders.delete(pid); } } screenStream.getTracks().forEach(t=>t.stop()); screenStream=null; removeShare('self'); await renegotiateAll(); }finally{ presentBtn.setAttribute('aria-pressed','false'); presentBtn.textContent='Present'; presentBtn.classList.remove('bg-blue-700'); presentBtn.classList.add('bg-slate-800'); show('Presentation ended'); } }

  // ===== Chat (dedup)
  let unread=0, chatOpen=false;
  function setUnread(n){ unread=Math.max(0,n); chatBadge.textContent=String(unread); chatBadge.classList.toggle('hidden', unread===0); }
  function openChat(){ chatPanel.classList.remove('hidden'); chatOpen=true; setUnread(0); chatInput.focus(); }
  function closeChat(){ chatPanel.classList.add('hidden'); chatOpen=false; }
  function pushMsg(who, text, mine=false){ const wrap=document.createElement('div'); wrap.className='msg-enter'; wrap.innerHTML=`<div class="flex ${mine?'justify-end':''}"><div class="max-w-[16rem] px-3 py-2 rounded-lg ${mine?'bg-blue-600 text-white':'bg-slate-800 border border-slate-700'}"><div class="text-[11px] opacity-80 mb-1">${escapeHtml(who)}</div><div class="text-sm break-words">${escapeHtml(text)}</div></div></div>`; chatList.append(wrap); requestAnimationFrame(()=>wrap.classList.add('go')); chatList.scrollTop=chatList.scrollHeight; if(!mine && !chatOpen) setUnread(unread+1); }
  function sendChat(){ const txt=(chatInput.value||'').trim(); if(!txt) return; chatInput.value=''; pushMsg(displayName, txt, true); send({t:'chat', name:displayName, text:txt, id:makeId()}); }

  // ===== signaling handler
  async function handleSignal(m){
    if (m.t==='hello'){ ensureTile(m.from); labelPeer(m.from, m.name||m.from); peerNames.set(m.from, m.name||m.from); if(myId>m.from) await makeOffer(m.from); send({t:'meta', name:displayName, id:makeId()}); refreshStatus(); }
    else if (m.t==='meta'){ ensureTile(m.from); labelPeer(m.from, m.name||m.from); peerNames.set(m.from, m.name||m.from); refreshStatus(); }
    else if (m.t==='offer' && m.to===myId){ await makeAnswer(m.from, m.s); }
    else if (m.t==='answer' && m.to===myId){ const pc=peers.get(m.from)||createPC(m.from); await pc.setRemoteDescription(m.s); }
    else if (m.t==='ice' && m.to===myId){ const pc=peers.get(m.from)||createPC(m.from); if(m.c){ try{ await pc.addIceCandidate(m.c);}catch{} } }
    else if (m.t==='bye'){ removePeer(m.from); }
    else if (m.t==='chat'){ pushMsg(m.name||m.from, m.text||''); }
  }

  // ===== controls
  chatToggle.onclick = ()=>{ chatOpen? closeChat() : openChat(); };
  chatClose.onclick = closeChat;
  chatSend.onclick = sendChat;
  chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });

  micBtn.onclick = ()=>{ const track=localStream?.getAudioTracks?.()[0]; if(!track){ show('Mic not available'); return; } track.enabled=!track.enabled; micIcon.textContent=track.enabled?'ðŸŽ¤':'ðŸ”‡'; };
  let deaf=false; deafenBtn.onclick=()=>{ deaf=!deaf; document.querySelectorAll('[data-peer] audio').forEach(a=>a.muted=deaf); deafenIcon.textContent = deaf ? 'ðŸ”‡' : 'ðŸ”Š'; };
  monitorBtn.onclick = ()=>{ if (monitorBtn.getAttribute('aria-pressed')==='true'){ stopMon(); } else { startMon(); } };
  monitorGain.oninput = ()=>{ if (monitorGainNode) monitorGainNode.gain.value=(parseInt(monitorGain.value,10)||0)/100; };
  presentBtn.onclick = ()=>{ if (presentBtn.getAttribute('aria-pressed')==='true') stopPresent(); else startPresent(); };
  speakerTestBtn.onclick = async ()=>{ try{ const ctx=new(window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=.06; o.connect(g).connect(ctx.destination); o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 350);}catch{ show('Speaker test failed'); } };
  leaveBtn.onclick = ()=>{ send({t:'bye', id:makeId()}); peers.forEach(pc=>{try{pc.close();}catch{}}); peers.clear(); stopMon(); stopPresent(); location.reload(); };

  // ===== join
  async function populateAndStartMic(){
    await enumerate();
    const s = await getMic(micSelect.value||undefined);
    if (s){ await attachMic(s); await startMon(); show('Mic ready (boosted)'); }
    else { show('Mic blocked or not found'); statusEl.textContent='Mic unavailable â€” you can still hear others'; }
  }
  async function beginJoin(){
    displayName = (nameInput.value||'').trim() || 'Guest';
    localStorage.setItem('displayName', displayName);
    joinOverlay.classList.add('hidden');
    ensureSelf(); labelSelf(displayName);
    await populateAndStartMic();
    const burst=()=>{ for(let i=0;i<3;i++) setTimeout(()=>{ send({t:'hello', name:displayName, id:makeId()}); send({t:'meta', name:displayName, id:makeId()}); }, i*120); };
    burst(); const helloInt=setInterval(()=>send({t:'hello', name:displayName, id:makeId()}),2000);
    setTimeout(()=>{ for(const id of peers.keys()){ makeOffer(id).catch(()=>{}); } },200);
    refreshStatus();
    window.addEventListener('beforeunload', ()=>{ clearInterval(helloInt); send({t:'bye', id:makeId()}); stopMon(); stopPresent(); });
  }
  joinBtn.onclick = beginJoin;
  nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') beginJoin(); });

  // kick discovery ping even before join
  setTimeout(()=>send({t:'hello', name:'(not joined yet)', id:makeId()}), 300);
  statusEl.textContent='Ready â€” pick a name';
})();
</script>
</body>
</html>
